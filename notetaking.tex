\documentclass{article}
\usepackage{rdfref-user}
\usepackage{marginnote}
\usepackage[utf8]{inputenc}
\usepackage[T1]{fontenc}
\usepackage[czech]{babel}
\usepackage{csquotes}

\makeatletter

% Formatting macros

% #1 - rdf:type 
% #2 formatting code
\newcommand\DeclareRdfFormat[2]{%
	\expandafter\newcommand\csname rdfformat#1\endcsname[1]{#2}
}

% #1 - rdf:type of printed element [optional]
% #2 - printed text
\newcommand\UseRdfFormat[2][]{%
	% use rdf:type of current object when optional argument is epmty
  \ifx\relax#1\relax%
	  \edef\tmp@curr{\GetProperty{\CurrentObject}{rdf:type}}%
	\else%
	  \edef\tmp@curr{#1}
	\fi%
	% make format name
	\edef\tmp@curr{rdfformat\tmp@curr}
	%\expandafter\typeout\expandafter{\tmp@curr}
	%\typeout{\ifcsdef{\tmp@curr}{format existuje}{format neexistuje}}
	\ifcsdef{\tmp@curr}{\csuse{\tmp@curr}{#2}}{\csuse{rdfformatdefault}{#2}}	
}

% this format will be used when no formatting exists for given rdf:type
\DeclareRdfFormat{default}{#1}

% #1 citekey for the publication
\newcommand\source[1]{%
	% define blank node prefix, this should enable using notes from 
	% multiple files
	\def\rdf@blk{#1}
	\BlankNode
	\AddProperty{rdf:type}{ann:source}
	\AddProperty{ann:citekey}{#1}
	\edef\notepagepub{\CurrentObject}%
}

% pagu number or some other identifier
\newcommand\notepage[1]{%
	\BlankNode%
  \AddProperty{rdf:type}{ann:pageNo}%
	\AddPropertyEx{ann:hasSource}{\notepagepub}%
	\AddPropertyEx{ann:hasIdentifier}{#1}%
	\edef\notepagelabel{\CurrentObject}% Save current
	%\printIdentifier{#1}%
	\UseRdfFormat{#1}
}

\DeclareRdfFormat{ann:pageNo}{\bgroup{\reversemarginpar\marginnote{[#1]}}\egroup}

% common annotation command, derived command should be used in the document
\newcommand\annotation[3][]{%
  \ifx\relax#1\relax%
	  \BlankNode%
  \else%
	  \def\CurrentObject{#1}%
  \fi%
	\AddProperty{rdf:type}{#2}%
	\AddPropertyEx{ann:refersTo}{\notepagelabel}%
	\AddProperty{ann:note}{#3}%
	\printAnnotation{#3}%
  \UseRdfFormat{#3}%
}

% this is to be redefined in derived annotation commands
\def\printAnnotation#1{#1}

\newcommand\notequote[2][]{%
\let\printAnnotation\enquote%
\annotation[#1]{ann:quote}{#2}%
}


\newcommand\notethought[2][]{%
\let\printAnnotation\textrm%
\annotation[#1]{ann:thought}{#2}%
}

\DeclareRdfFormat{ann:thought}{\par \textit{#1}}

\begin{document}
\title{Book reading notetaking system with rdfref}

\source{bib:pepa14}
\notepage{1}

\notequote{Ahoj světe}
\notethought[ex:uff]{To je ale \textit{něco}}
Co je třeba

- definovat zpracovávanou publikaci
- odkazovat na definovatelný pasáže (stránky, nadpisy, čísla sekcí)
- v makru uchovávat label současný pasáže
- v poznmkách a citacích se odkazovat na label pasáže
- poznámky samostatný autoimatický labely nebo labely v nepovinných parametrech
- odkazy na otázky, slovník atd se vztahují k poznámkám

\end{document}

